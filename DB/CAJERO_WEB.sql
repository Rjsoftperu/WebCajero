IF DB_ID('CAJERO_WEB')IS NOT NULL
BEGIN
	USE master
	DROP DATABASE CAJERO_WEB
END
GO
CREATE DATABASE CAJERO_WEB
GO 
USE CAJERO_WEB
GO
CREATE TABLE USUARIO(
	DNI CHAR(8)NOT NULL primary key,
	NTARJETA CHAR(16)NOT NULL UNIQUE,
	PING CHAR(4) NOT NULL ,	
	ESTADO VARCHAR(11) NOT NULL,
)
GO
CREATE TABLE CLIENTE(
		DNI CHAR(8) NOT NULL primary key,
		NOMBRE VARCHAR(30),
		APELLIDO VARCHAR(50),
		DIRECCION VARCHAR(50),
		EDAD INT,
		TELEFONO VARCHAR(15),
		EMAIL VARCHAR(30)
)
GO
CREATE TABLE CUENTA(
	NCUENTA CHAR(16) NOT NULL primary key,
	DNI_CLIENTE CHAR(8)NOT NULL,
	TIPO_CUENTA CHAR(5) NOT NULL,
	NTARJETA CHAR(16),	
	SALDO MONEY
)
GO
CREATE TABLE CATEGORIA_CUENTA(
	ID_CATCUENTA CHAR(5)NOT NULL primary key,
	DESCRIPCION VARCHAR(15)
)
GO
CREATE TABLE TARJETA(
NTARJETA CHAR(16)NOT NULL primary key,
NOMBRETARJETA VARCHAR(50)
)
GO

CREATE TABLE DETALLE_TRANSACCION(
ID_DET_TRANSACCION INT IDENTITY NOT NULL ,
ID_TRANSACCION CHAR(5)NOT NULL,
NCUENTA CHAR(16) NOT NULL,
NCUENTADESTINO CHAR(16),
FECHA_TRANSACCION DATETIME,
MONTO MONEY
)
GO

CREATE TABLE TRANSACCION(
ID_TRANSACCION CHAR(5)NOT NULL primary key,
TIPO_TRANSACCION VARCHAR(30) NOT NULL,
)
GO

CREATE TABLE DISTRIBUCIONBILLETE (
COD_BILLETE CHAR(4),--B100
CANTIDAD MONEY
)

ALTER TABLE USUARIO
ADD FOREIGN KEY (DNI) REFERENCES CLIENTE

ALTER TABLE USUARIO
ADD FOREIGN KEY (NTARJETA) REFERENCES TARJETA


ALTER TABLE CUENTA
ADD FOREIGN KEY (DNI_CLIENTE) REFERENCES CLIENTE

ALTER TABLE CUENTA
ADD FOREIGN KEY (TIPO_CUENTA) REFERENCES CATEGORIA_CUENTA

ALTER TABLE DETALLE_TRANSACCION
ADD FOREIGN KEY (ID_TRANSACCION) REFERENCES TRANSACCION

ALTER TABLE CUENTA
ADD FOREIGN KEY (NTARJETA) REFERENCES TARJETA

ALTER TABLE DETALLE_TRANSACCION
ADD FOREIGN KEY (NCUENTA) REFERENCES CUENTA


-- :::::::::::: procedimiemto almacenado:::::::::::

--verificar usuario-----
CREATE PROCEDURE USP_VERIFICAR_USUARIO
@NTARJETA CHAR(16),
@PING CHAR(4)
AS
SELECT DNI FROM USUARIO 
WHERE PING =@PING and NTARJETA=@NTARJETA AND ESTADO='ACTIVO'
GO

----capturar id cliente y su cuenta
create procedure datosconectado
@NTARJETA varchar(16)
as
select * from TARJETA 
inner join CUENTA on CUENTA.NTARJETA=TARJETA.NTARJETA
where TARJETA.NTARJETA=@NTARJETA


--verificar tarjeta-----------
CREATE PROCEDURE USP_VERIFICAR_TARJETA
@NTARJETA CHAR(16)
AS
SELECT * FROM USUARIO 
WHERE NTARJETA=@NTARJETA AND ESTADO='ACTIVO'
GO

---bloquear usuario----
CREATE PROCEDURE USP_BLOQUEAR_USUARIO
@NTARJETA CHAR(16)
AS
UPDATE USUARIO SET
ESTADO='BLOQUEADO' 
WHERE NTARJETA =@NTARJETA 
GO


--activar usuario---
CREATE PROCEDURE USP_ACTIVAR_USUARIO 
@NTARJETA CHAR(16)
AS
UPDATE USUARIO SET
ESTADO='ACTIVO' 
WHERE NTARJETA =@NTARJETA 
GO
----cambio clave------------

create procedure USP_cambiar_clave
@NTARJETA char(16),
@PING CHAR(4)
as
update USUARIO SET
PING=@PING 
WHERE NTARJETA =@NTARJETA 



-----PROCEDIMIENTO CONSULTAR SALDO------
CREATE PROCEDURE USP_consultarSaldo 
@NCUENTA CHAR(16)
AS
select SALDO from cuenta
WHERE NCUENTA=@NCUENTA

---------------------------------------------------------------------
--REGISTRAR transferencias--------

CREATE PROCEDURE USP_registrar_transferencia
@NCUENTA CHAR(16),
@NCUENTADESTINO CHAR(16),
@MONTO MONEY
AS
insert into DETALLE_TRANSACCION values('2',@NCUENTA,@NCUENTADESTINO,GETDATE(),@MONTO)
update CUENTA set
SALDO=SALDO-@MONTO
where NCUENTA=@NCUENTA
update CUENTA set
SALDO=SALDO+@MONTO
where NCUENTA=@NCUENTADESTINO



--REGISTRAR depositos--------

CREATE PROCEDURE USP_registrar_depositos
@NCUENTA CHAR(16),
@MONTO MONEY
AS
insert into DETALLE_TRANSACCION values('4',@NCUENTA,@NCUENTA,GETDATE(),@MONTO)
update CUENTA set
SALDO=SALDO+@MONTO
where NCUENTA=@NCUENTA


--REGISTRAR retiro--------

CREATE PROCEDURE USP_registrar_retiro
@NCUENTA CHAR(16),
@MONTO MONEY
AS
insert into DETALLE_TRANSACCION values('1',@NCUENTA,@NCUENTA,GETDATE(),@MONTO)
update CUENTA set
SALDO=SALDO-@MONTO
where NCUENTA=@NCUENTA

--REGISTRAR pagoservicio--------

CREATE PROCEDURE USP_registrar_pagoservicio
@NCUENTA CHAR(16),
@NCUENTADESTINO CHAR(16),
@MONTO MONEY
AS
insert into DETALLE_TRANSACCION values('3',@NCUENTA,@NCUENTADESTINO,GETDATE(),@MONTO)
update CUENTA set
SALDO=SALDO-@MONTO
where NCUENTA=@NCUENTA

---consultar movimientos.------

CREATE PROCEDURE USP_consultar_movimientos
@NCUENTA CHAR(16)
AS
select top(10)TIPO_TRANSACCION AS TRANSACCION,MONTO AS MONTO,FECHA_TRANSACCION AS FECHA from DETALLE_TRANSACCION
inner join TRANSACCION on TRANSACCION.ID_TRANSACCION=DETALLE_TRANSACCION.ID_TRANSACCION
WHERE NCUENTA=@NCUENTA
order by FECHA_TRANSACCION desc


------validar cuenta-------------
CREATE PROCEDURE USP_validar_cuenta 
@NCUENTA CHAR(16)
AS
SELECT (APELLIDO+'  ,'+NOMBRE)as CLIENTE FROM CUENTA 
INNER JOIN CLIENTE ON CLIENTE.DNI=CUENTA.DNI_CLIENTE
WHERE NCUENTA =@NCUENTA
GO



-------------cargar billetes al cajero
CREATE PROCEDURE USP_cargar_billetes_cajero
@B100 MONEY,
@B50 MONEY,
@B20 MONEY,
@B10 MONEY
as
UPDATE DISTRIBUCIONBILLETE SET
CANTIDAD =CANTIDAD+@B100 WHERE COD_BILLETE ='B100'
UPDATE DISTRIBUCIONBILLETE SET
CANTIDAD =CANTIDAD+@B50 WHERE COD_BILLETE ='B50'
UPDATE DISTRIBUCIONBILLETE SET
CANTIDAD =CANTIDAD+@B20 WHERE COD_BILLETE ='B20'
UPDATE DISTRIBUCIONBILLETE SET
CANTIDAD =CANTIDAD+@B10 WHERE COD_BILLETE ='B10'

----------validar disponibilidad de billetes'B100'---------------

create procedure USP_retirar_billetes
@monto money
as
DECLARE @TOTAL MONEY
DECLARE @B100 MONEY
DECLARE @B50 MONEY
DECLARE @B20 MONEY
DECLARE @B10 MONEY
DECLARE @MENSAJE VARCHAR(80)
select @TOTAL=sum(CANTIDAD) from DISTRIBUCIONBILLETE
select @B100=CANTIDAD from DISTRIBUCIONBILLETE
where COD_BILLETE='B100'
select @B50=CANTIDAD from DISTRIBUCIONBILLETE
where COD_BILLETE='B50'
select @B20=CANTIDAD from DISTRIBUCIONBILLETE
where COD_BILLETE='B20'
select @B10=CANTIDAD from DISTRIBUCIONBILLETE
where COD_BILLETE='B10'
if (@TOTAL>=@monto)
begin
		IF ((@monto/100)>=1) 
		begin
			IF @B100>=((@monto/100)*100) 
				BEGIN		
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-((@monto/100)*100)) WHERE COD_BILLETE ='B100'	
				set @monto=@monto-(@monto/100)*100
				end	
			else if ((@monto/100)*100)>=100  and @B100>0
				BEGIN	--30	
				set @monto =(@monto-@B100)
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-CANTIDAD) WHERE COD_BILLETE ='B100'			
				END	
		end
		
		IF ((@monto/50)>=1) 
		begin
			IF @B50>=((@monto/50)*50) 
				BEGIN		
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-((@monto/50)*50)) WHERE COD_BILLETE ='B50'	
				set @monto=@monto-(@monto/50)*50
				end	
			else if ((@monto/50)*50)>=50  and @B50>0
				BEGIN	--30	
				set @monto =(@monto-@B50)
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-CANTIDAD) WHERE COD_BILLETE ='B50'				
				END	
			
		end
		IF ((@monto/20)>=1) 
		begin
			IF @B20>=((@monto/20)*20) 
				BEGIN		
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-((@monto/20)*20)) WHERE COD_BILLETE ='B20'	
				set @monto=@monto-(@monto/20)*20
				end	
			else if ((@monto/20)*20)>=20  and @B20>0
				BEGIN	--30	
				set @monto =(@monto-@B20)
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-CANTIDAD) WHERE COD_BILLETE ='B20'				
				END	
			
		end
		
		IF ((@monto/10)>=1) 
		begin
			IF @B10>=((@monto/10)*10) 
				BEGIN		
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-((@monto/10)*10)) WHERE COD_BILLETE ='B10'	
				set @monto=@monto-(@monto/10)*10
				end	
			else if ((@monto/10)*10)>=10  and @B10>0
				BEGIN	--30	
				set @monto =(@monto-@B10)
				UPDATE DISTRIBUCIONBILLETE SET
				CANTIDAD =(CANTIDAD-CANTIDAD) WHERE COD_BILLETE ='B10'				
				END	
			
		end
	SET @MENSAJE='Operacion Realizada con exito'
	SELECT @MENSAJE
end
else
begin
	
	SET @MENSAJE= 'El sistema solo cuenta con S/  ' + CONVERT(varchar(10),@TOTAL) + '  Disponibles, Gracias'
	SELECT @MENSAJE
end

select * from DISTRIBUCIONBILLETE

---------- consultar saldo disponible a retirar del cajero ---------------

create procedure USP_saldo_disponible_cajero
as
select sum(CANTIDAD) from DISTRIBUCIONBILLETE
select * from DETALLE_TRANSACCION


-- :::::::::::::::: inser into:::::::::.---

---TARJETA -------
insert into TARJETA values('3333333333333333','DORADA')
insert into TARJETA values('2222222222222222','CLASICA')
insert into TARJETA values('1111111111111111','PLATINIUM')
insert into TARJETA values('4444444444444444','GOLD')

select * from TARJETA
TRUNCATE TABLE TARJETA

---CLIENTES--
insert into CLIENTE values('11111111','MARTIN','PILAR','CALLE 8',25,'5274082','LEO_14@HOTMAIL.COM')
insert into CLIENTE values('22222222','CARLOS','YPARAQUE','JR OCAÑA 123',30,'3285656','CAR@HOTMAIL.COM')
insert into CLIENTE values('33333333','IRINA','ROJAS','LOS ALAMOS 56',40,'5224081','IRINA_ROJAS@HOTMAIL.COM')
insert into CLIENTE values('44444444','IRmA','ROsAS','LOS AMOS 6',40,'5221085','IRNA_RAS@HOTMAIL.COM')

select * from CLIENTE
TRUNCATE TABLE CLIENTE


--USUARIO
insert into USUARIO values('11111111','3333333333333333','1562','ACTIVO')
insert into USUARIO values('22222222','2222222222222222','1522','BLOQUEADO')
insert into USUARIO values('33333333','1111111111111111','1111','ACTIVO')
insert into USUARIO values('44444444','4444444444444444','1111','ACTIVO')

select * from USUARIO
TRUNCATE TABLE USUARIO

--CATEGORIA CUENTA ---
insert into CATEGORIA_CUENTA values('1','CUENTA SUELDO')
insert into CATEGORIA_CUENTA values('2','CUENTA AHORROS')
insert into CATEGORIA_CUENTA values('3','CUENTA CTS')

select * from CATEGORIA_CUENTA
TRUNCATE TABLE CATEGORIA_CUENTA



--CUENTA--
insert into CUENTA values('3333333333333333','11111111','1','3333333333333333',1500)
insert into CUENTA values('2222222222222222','22222222','2','2222222222222222',3680)
insert into CUENTA values('1111111111111111','33333333','3','1111111111111111',5056)
insert into CUENTA values('4444444444444444','44444444','1','4444444444444444',100)

select * from CUENTA
TRUNCATE TABLE CUENTA

---INSERTAR TRANSACICON---------
insert into TRANSACCION values('1','RETIRO')
insert into TRANSACCION values('2','TRANSFERENCIA')
insert into TRANSACCION values('3','PAGO SERVICIO')
insert into TRANSACCION values('4','DEPOSITO')

select * from TRANSACCION
TRUNCATE TABLE TRANSACCION

--INSERT DETALLE TRANSACCIONES---
insert into DETALLE_TRANSACCION values('2','3333333333333333','1111111111111111',GETDATE(),200)
insert into DETALLE_TRANSACCION values('2','3333333333333333','1111111111111111',GETDATE(),200)
insert into DETALLE_TRANSACCION values('2','2222222222222222','1111111111111111',GETDATE(),200)
insert into DETALLE_TRANSACCION values('2','1111111111111111','3333333333333333',GETDATE(),200)
insert into DETALLE_TRANSACCION values('4','3333333333333333','2222222222222222',GETDATE(),200)

select * from DETALLE_TRANSACCION
TRUNCATE TABLE DETALLE_TRANSACCION

-----INSERT BILLETES----------
INSERT INTO DISTRIBUCIONBILLETE VALUES('B10',1000)
INSERT INTO DISTRIBUCIONBILLETE VALUES('B20',1000)
INSERT INTO DISTRIBUCIONBILLETE VALUES('B50',1000)
INSERT INTO DISTRIBUCIONBILLETE VALUES('B100',1000)

select * from DISTRIBUCIONBILLETE
TRUNCATE TABLE DISTRIBUCIONBILLETE


select top(10)* from DETALLE_TRANSACCION
where ncuenta='1111111111111111'
order by fecha_transaccion desc

